<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
　　 <title>グラフ</title> 
</head>
  <body>
　　<h1>グラフ</h1>
    <form name="chartform">
      <input name="myfile" type="file" />
      <textarea name="output" cols="40" rows="1"></textarea>
    </form>
    <form name="chartform01">
      <input name="myfile" type="file" />
      <textarea name="output" cols="40" rows="1"></textarea>
    </form>
    <canvas id="myChart"></canvas>
    <script type="text/javascript" src="js/node_modules/chart.js/dist/chart.js"></script>
    <script type="text/javascript" src="js/node_modules/chart.js/dist/chart.min.js"></script>
    <script type="text/javascript" src="js/node_modules/jquery/dist/jquery.min.js"></script>
    <script src="chart_draw.js"></script>

    <script language="javascript" type="text/javascript">
      
      //main_json();
      //main_json2();
      //main_json3();
      main_json_file();
      //main_json_files();
      
      function main_json() {
        //var url = "http://localhost:81/chart_item.json";
        //var url = "Access-Control-Allow-Origin: http://localhost:81/chart_item.json";
        var url = "http://localhost:81/chart_item.json?callback=?";
        console.log(url);
        $.getJSON(url)
          .done(function(json){
            // 成功時処理
            console.log(json);
            var labels = getLabels(json);
            var data = getData(json);
            makeLineChart(data, labels);
        }).fail(function(jqXHR, textStatus, errorThrown){
            // 失敗時処理
            console.log("実行失敗");
            // httpステータス
            console.log("jqXHR : " + jqXHR.status);
            // タイムアウト、パースエラー
            console.log("textStatus : " + textStatus);
            // エラーの詳細情報
            console.log("errorThrown : " + errorThrown.message);
        }).always(function(){
            // 常時実行処理

        });
      }

      function main_json2(){
        $.ajax({
          type: "GET",
          url: "http://localhost:81/chart_item.json?callback=?",
          contentType: 'application/json',
          dataType: "json",
          success: function(json){
            // 成功時処理
            console.log(json);
            var labels = getLabels(json);
            var data = getData(json);
            makeLineChart(data, labels);
	        }
        });
      }

      function main_json3(){
        async function load() {
          const fd = await fetch('chart_item.json');
          const json = await fd.json();
          //var json = JSON.parse(text);
          console.log(json);
          var labels = getLabels(json);
          var data = getData(json);
          makeLineChart(data, labels);
        }
        load();
      }

      function main_json_file() {
        var form = document.forms.chartform;
        form.myfile.addEventListener('change', function(e) {
          var result = e.target.files[0]; //読み込んだファイル情報を取得
          console.log( result );
          var reader = new FileReader();
          reader.readAsText( result );  //読み込んだファイルの中身を取得する
          //ファイルの中身を取得後に処理を行う
          reader.addEventListener( 'load', function() {
            form.output.textContent = reader.result; 
            json = JSON.parse(reader.result);
            console.log(json);
            var labels = getLabels(json);
            var data = getData(json);
            makeLineChart(data, labels);
          })
        })
           
      }

      function main_json_files(){
        var data;
        var labels;
        var form = document.forms.chartform;
        getFile(form);
        makeLineChart(data, labels);

      }

      function getFile(form){
        form.myfile.addEventListener('change', function(e) {
          var result = e.target.files[0]; //読み込んだファイル情報を取得
          console.log( result );
          var reader = new FileReader();
          reader.readAsText( result );  //読み込んだファイルの中身を取得する
          //ファイルの中身を取得後に処理を行う
          reader.addEventListener( 'load', function() {
            form.output.textContent = reader.result; 
            json = JSON.parse(reader.result);
            console.log(json);
            labels = getLabels(json);
            data = getData(json);
          })
        })
      }

      function getLabels(json) {
        var labels = [];
        for (let i=0; i<json.length; i++){
          labels[i] = json[i].date;
        }
        return labels;
      }

      function getData(json) {
        var data = [];
        for (let i=0; i<json.length; i++){
          data[i] = json[i].data;
          //console.log(`date=${data[i].date}, data=${data[i].data}`);
        }
        return data;
      }

      function makeLineChart(data, labels) {
        var ctx = document.getElementById("myChart").getContext('2d');
              var chart = new Chart(ctx, {
                type: 'line',
                data: {
                  labels: labels,
                  datasets: [
                    {
                      label: "死亡者数", 
                      data: data,
                      borderColor: "rgba(255,0,0,1)",
                      backgroundColor: "rgba(0,0,0,0)",
                      borderWidth: 1
                    },
                  ]
                },
                options: {
                   //responsive: true,
                   //maintainAspectRatio: false,
                   legend: {
                       //display: false
                   },
                   title: {
                       display: true,
                       text: 'title'
                   },
                   scales: {
                      yAxes: [{
                        ticks: {
                          suggestedMax: 40,
                          suggestedMin: 0,
                          stepSize: 10,
                          callback: function(value, index, values){
                            return  value +  ''
                          }
                        }
                      }]
                    },
                }
              });
      }



      function main_csv() {
        var req = new XMLHttpRequest();
        var filePath = 'data.csv'; //CSVファイルのパスは適宜変更してください。
        req.open('GET', filePath, true);
        req.onload = function() {
            console.log(req.responseText);
            var title = csv2Title(req.responseText);
            var data = csv2Array(req.responseText);
            console.log(data);
            var tmpLabels = [], //ラベル（項目はひとつ）
            tmpData1 = []; //データ系列の数だけ設定

          for (var row in data) {
              tmpLabels.push(data[row][0])
              tmpData1.push(data[row][1]) //データ系列の数だけ設定

          };
          //tmpLabels = tmpLabels.slice(0, -1);
          //エクセルでCSVファイルを作るとデータの最後にカンマ（,）が追加されて、グラフに空白列が増えてしまうので最後のカンマを削除する

          var ctx = document.getElementById('myChart').getContext('2d');

          var myChart = new Chart(ctx, {
              type: 'bar',
              data: {
                  labels: tmpLabels,
                  datasets: [
                      {
                          label: title[0],
                          data: tmpData1
                      }  //データ系列の数だけ準備
                      
                  ]
              },
              options: {
                
              },       
          });
        }
        req.send(null);
      };

      function csv2Title(str) {
        var lines = str.split('\n');
        return lines[0].split(',');
      }

      function csv2Array(str) { //
        var csvData = [];
        for (var i = 1; i < lines.length; ++i) {
            var cells = lines[i].split(',');
            csvData.push(cells);
        };
        return csvData;
      };

      
    </script>

  </body>
</html>